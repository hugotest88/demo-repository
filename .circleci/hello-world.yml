version: 2.1

jobs:
  build:
    docker:
      - image: cimg/node:20.16.0
        auth:
          username: flowersandscumbags
          password: $xxxxxxxxxxxxxxxxxxx
    steps:
      - setup_remote_docker  # Enable Docker commands within CircleCI
      - checkout  # Check out the source code
      - restore_cache:  # Restore dependency cache if available
          keys:
            - v1-dependencies-{{ checksum "package.json" }}
            - v1-dependencies-
      - run:
    name: Install Python dependencies
    command: |
      python3 -m venv venv
      . venv/bin/activate
      pip install -r requirements.txt
      
      - run:
          name: Install Dependencies
          command: npm install --legacy-peer-deps
      - save_cache:  # Save dependency cache for future builds
          paths:
            - ./node_modules
          key: v1-dependencies-{{ checksum "package.json" }}
      - run:
          name: Build Docker Image
          command: docker build -t flowersandscumbags/automated-license-checker .
      - run:
          name: Push Docker Image to Docker Hub
          command: |
            echo $DOCKERHUB_ACCESS_TOKEN | docker login -u flowersandscumbags --password-stdin
            docker push flowersandscumbags/automated-license-checker
      - run:
          name: Run Tests
          command: npm test
      - run:
          name: Notify Datadog
          command: |
            if [ -n "$DATADOG_API_KEY" ]; then
              curl -X POST -H "Content-type: application/json" \
              -d '{"title": "Build completed", "text": "The build has completed successfully.", "priority": "normal"}' \
              "https://api.datadoghq.com/api/v1/events?api_key=${DATADOG_API_KEY}"
            else
              echo "Datadog API key not found"
            fi
      - run:
          name: Deploy to Heroku
          command: |
            echo "  machine api.heroku.com" > ~/.netrc
            echo "  login $HEROKU_EMAIL" >> ~/.netrc
            echo "  password $HEROKU_API_KEY" >> ~/.netrc
            echo "  machine git.heroku.com" >> ~/.netrc
            echo "  login $HEROKU_EMAIL" >> ~/.netrc
            echo "  password $HEROKU_API_KEY" >> ~/.netrc
            git remote add heroku https://git.heroku.com/stark-wave-12950.git
            git push heroku main

workflows:
  jobs:
    - build

#jobs:
 # buildTag:
 #   docker:
 #     - image: cimg/node:17.2.0 # the primary container, where your job's commands are run
 #   steps:
 #     - checkout # check out the code in the project directory
#      - run: echo "hello world" # run the `echo` command

 # buildNoTag:
 #   docker:
 #     - image: cimg/node:17.2.0 # the primary container, where your job's commands are run
 #   steps:
 #     - checkout # check out the code in the project directory 
 #     - run: echo "hello world" # run the `echo` command 
 #     - run: echo $CIRCLE_PULL_REQUEST
 #     - run: echo $CIRCLE_REPOSITORY_URL
 #    - run: echo "This is pipeline ID << pipeline.id >>"
 #     - run: echo "This is base revision << pipeline.git.base_revision >>" 
 #     - run: echo << pipeline.trigger_parameters.github_app.repo_url >>  
 #     - run: echo $CIRCLE_PR_REPONAME 
 #     - run: echo $CIRCLE_PR_NUMBER

  

#workflows:
#  testGHApp:
#   jobs:
      - build_arm64
#  tagged-build:
#    jobs: 
#      - buildTag:
#          filters:
#            tags:
#              only: /^v.*/
#            branches:
#              ignore: /.*/ 
